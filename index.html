<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Cosmiq 5 - General Diagnostics</title>
        <style>
            :root {
                --bg: #1e1e1e;
                --text: #e0e0e0;
                --accent: #007acc;
                --log-bg: #101010;
            }
            body {
                font-family: "Consolas", "Monaco", monospace;
                background: var(--bg);
                color: var(--text);
                padding: 15px;
                max-width: 700px;
                margin: 0 auto;
            }

            h1 {
                font-size: 18px;
                border-bottom: 1px solid #444;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }

            /* Buttons */
            button {
                cursor: pointer;
                border: none;
                font-family: inherit;
                font-weight: bold;
                padding: 10px 15px;
                border-radius: 4px;
                font-size: 14px;
                transition: 0.1s;
                display: block;
                width: 100%;
                margin-bottom: 10px;
            }
            .btn-conn {
                background: #28a745;
                color: white;
            }
            .btn-test {
                background: #ffc107;
                color: #333;
            }
            .btn-disc {
                background: #dc3545;
                color: white;
                display: none;
            }

            /* Layout */
            .controls {
                display: none;
                border: 1px solid #444;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 20px;
                background: #252526;
            }
            .row {
                display: flex;
                gap: 10px;
                margin-bottom: 10px;
                align-items: center;
            }
            .label {
                width: 120px;
                font-size: 12px;
                color: #888;
            }

            /* Inputs */
            select,
            input {
                background: #3c3c3c;
                border: 1px solid #555;
                color: white;
                padding: 5px;
                border-radius: 3px;
                flex: 1;
            }

            /* Logs */
            #log {
                font-size: 11px;
                background: var(--log-bg);
                border: 1px solid #333;
                height: 400px;
                overflow-y: scroll;
                padding: 10px;
                white-space: pre-wrap;
                border-radius: 4px;
                line-height: 1.5;
                color: #bbb;
            }
            .tx {
                color: #569cd6;
            } /* Blue */
            .rx {
                color: #ce9178;
            } /* Orange */
            .info {
                color: #6a9955;
                font-weight: bold;
            } /* Green */
            .err {
                color: #f44747;
                font-weight: bold;
            } /* Red */
            .sys {
                color: #dcdcaa;
            } /* Yellow */
        </style>
    </head>
    <body>
        <h1>Cosmiq 5 - General Diagnostics</h1>

        <button id="btnConn" class="btn-conn" onclick="connect()">
            1. CONNECT & SYNC
        </button>
        <button
            id="btnTest"
            class="btn-test"
            onclick="runGeneralTest()"
            style="display: none"
        >
            2. TEST GENERAL SETTINGS (AUTO)
        </button>
        <button id="btnDisc" class="btn-disc" onclick="disconnect()">
            DISCONNECT
        </button>

        <div id="controls" class="controls">
            <div class="row">
                <span class="label">Default Mode</span>
                <button onclick="setMode(0)" style="width: auto; flex: 1">
                    Scuba
                </button>
                <button onclick="setMode(2)" style="width: auto; flex: 1">
                    Freedive
                </button>
                <button onclick="setMode(1)" style="width: auto; flex: 1">
                    Gauge
                </button>
            </div>
            <div class="row">
                <span class="label">Timeout (Index)</span>
                <select id="selTime">
                    <option value="0">Index 0</option>
                    <option value="1">Index 1</option>
                    <option value="2">Index 2</option>
                    <option value="3">Index 3</option>
                </select>
                <button onclick="setTimeoutIndex()" style="width: auto">
                    Set
                </button>
            </div>
            <div class="row">
                <span class="label">Backlight (1-5)</span>
                <input type="number" id="inpBL" value="3" min="1" max="5" />
                <button onclick="setBacklight()" style="width: auto">
                    Set
                </button>
            </div>
        </div>

        <div id="log">Waiting...</div>

        <script>
            const SVC_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
            let dev, tx, rx;

            // --- LOGGER ---
            function log(msg, type = "") {
                const el = document.getElementById("log");
                el.innerHTML += `<span class="${type}">${msg}</span>\n`;
                el.scrollTop = el.scrollHeight;
            }

            // --- CONNECTION ---
            async function connect() {
                try {
                    log("Scanning...", "sys");
                    dev = await navigator.bluetooth.requestDevice({
                        filters: [
                            { namePrefix: "COS" },
                            { namePrefix: "Deep" },
                        ],
                        optionalServices: [SVC_UUID],
                    });
                    dev.addEventListener("gattserverdisconnected", onDisc);

                    const server = await dev.gatt.connect();
                    const service = await server.getPrimaryService(SVC_UUID);

                    // Smart Char Discovery
                    const chars = await service.getCharacteristics();
                    for (const c of chars) {
                        if (
                            c.properties.write ||
                            c.properties.writeWithoutResponse
                        )
                            tx = c;
                        if (c.properties.notify) rx = c;
                    }

                    await rx.startNotifications();
                    rx.addEventListener("characteristicvaluechanged", handleRX);

                    document.getElementById("btnConn").style.display = "none";
                    document.getElementById("btnDisc").style.display = "block";
                    document.getElementById("btnTest").style.display = "block";
                    document.querySelector(".controls").style.display = "block";

                    log("Connected. Syncing...", "info");
                    await readAll();
                } catch (e) {
                    log("Error: " + e, "err");
                }
            }

            function disconnect() {
                if (dev) dev.gatt.disconnect();
            }

            function onDisc() {
                document.getElementById("btnConn").style.display = "block";
                document.getElementById("btnDisc").style.display = "none";
                document.getElementById("btnTest").style.display = "none";
                document.querySelector(".controls").style.display = "none";
                log("Disconnected", "err");
            }

            // --- PROTOCOL HANDLER ---
            function handleRX(event) {
                let dec = new TextDecoder();
                let text = dec.decode(event.target.value).trim();
                let clean = text.replace(/[^0-9A-Fa-f]/g, "").toUpperCase();

                // Log raw RX with label
                let label = "Unknown";
                let cmd = clean.substr(0, 2);

                if (cmd === "58") label = "System Info";
                if (cmd === "5F") label = "Backlight Config";
                if (cmd === "5B") label = "Scuba Config 2";
                if (cmd === "5C") label = "Scuba Config 1";
                if (cmd === "5D") label = "Freedive Depths";
                if (cmd === "60") label = "Freedive Time";
                if (clean.startsWith("80")) {
                    log(`NACK (Rejected): ${clean}`, "err");
                    return;
                }
                if (clean.startsWith("2")) {
                    log(`ACK (Accepted): ${clean}`, "info");
                    return;
                }

                log(`RX [${label}]: ${clean}`, "rx");

                // PARSERS (General Only)
                if (cmd === "5F") {
                    let bl = parseInt(clean.substr(10, 2), 16);
                    log(`   > REPORT: Backlight Level = ${bl}`, "info");
                }
                if (cmd === "5B") {
                    let mode = parseInt(clean.substr(16, 2), 16);
                    let modeStr =
                        mode === 0
                            ? "Scuba"
                            : mode === 1
                              ? "Gauge"
                              : "Freedive";
                    log(
                        `   > REPORT: Default Mode = ${mode} (${modeStr})`,
                        "info",
                    );
                }
                if (cmd === "5C") {
                    let to = parseInt(clean.substr(10, 4), 16);
                    log(`   > REPORT: Timeout Index = ${to}`, "info");
                }
            }

            async function send(cmd, desc) {
                log(`TX [${desc}]: ${cmd}`, "tx");
                let enc = new TextEncoder();
                await tx.writeValue(enc.encode(cmd + "\n"));
            }

            // --- MATH HELPERS ---
            // Target: 214 (0xD6). Formula: Target - (Len + ValSum). Len=4.
            function getTimeoutCmd(idx) {
                let target = 214;
                let len = 4;
                let sum = len + idx;
                let check = (target - sum) & 0xff;
                let checkHex = check
                    .toString(16)
                    .padStart(2, "0")
                    .toLowerCase();
                let valHex = idx.toString(16).padStart(4, "0");
                return `#2a${checkHex}04${valHex}`;
            }

            // Target: 210 (0xD2). Formula: Target - (Len + ValSum). Len=2.
            function getBLCmd(lvl) {
                let target = 210;
                let len = 2;
                let sum = len + lvl;
                let check = (target - sum) & 0xff;
                let checkHex = check
                    .toString(16)
                    .padStart(2, "0")
                    .toLowerCase();
                let valHex = lvl.toString(16).padStart(2, "0");
                return `#2e${checkHex}02${valHex}`;
            }

            // --- ACTIONS ---
            async function readAll() {
                await send("#5f9f0200", "Read Backlight");
                await wait(300);
                await send("#5ba30200", "Read Mode");
                await wait(300);
                await send("#5ca20200", "Read Timeout");
                await wait(300);
            }

            async function setMode(m) {
                let cmd =
                    m === 0 ? "#2bd30200" : m === 2 ? "#2bd10202" : "#2bd20201";
                let name = m === 0 ? "Scuba" : m === 2 ? "Freedive" : "Gauge";
                await send(cmd, `Set Mode ${name}`);
            }

            async function setTimeoutIndex() {
                let idx = parseInt(document.getElementById("selTime").value);
                await send(getTimeoutCmd(idx), `Set Timeout Idx ${idx}`);
            }

            async function setBacklight() {
                let l = parseInt(document.getElementById("inpBL").value);
                await send(getBLCmd(l), `Set Backlight ${l}`);
            }

            function wait(ms) {
                return new Promise((r) => setTimeout(r, ms));
            }

            // --- THE SYSTEM TEST ---
            async function runGeneralTest() {
                log("=== STARTING GENERAL SETTINGS TEST ===", "sys");

                // 1. MODES
                let modes = [0, 1, 2];
                let mNames = ["Scuba", "Gauge", "Freedive"];
                for (let i = 0; i < 3; i++) {
                    log(`--- Testing Mode: ${mNames[i]} ---`, "sys");
                    await setMode(modes[i]);
                    await wait(800);
                    await send("#5ba30200", "Verify Mode");
                    await wait(800);
                }

                // 2. TIMEOUTS (Testing Indices 0-3)
                for (let i = 0; i <= 3; i++) {
                    log(`--- Testing Timeout Index: ${i} ---`, "sys");
                    let cmd = getTimeoutCmd(i);
                    await send(cmd, `Set Timeout ${i}`);
                    await wait(800);
                    await send("#5ca20200", "Verify Timeout");
                    await wait(800);
                }

                // 3. BACKLIGHT (1-5)
                for (let i = 1; i <= 5; i++) {
                    log(`--- Testing Backlight: ${i} ---`, "sys");
                    let cmd = getBLCmd(i);
                    await send(cmd, `Set BL ${i}`);
                    await wait(800);
                    await send("#5f9f0200", "Verify Backlight");
                    await wait(800);
                }
                log("=== TEST COMPLETE ===", "sys");
            }
        </script>
    </body>
</html>
